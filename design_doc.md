# 朝電車の遅延があった場合通知してくれるアプリ

## プロジェクトの目的

朝に登録した路線で遅延があった際にLineで通知する。路線登録後「遅延」と送ると遅延があるか調べる。

## プロジェクトの背景

前職では店舗によって出勤時に遅延があった際、決められた時間までに報告する必要がありました。駅に着いてから遅延を報告すると報告の時間に間に合わないため毎朝路線情報をチェックしていました。煩わしい路線情報のチェックを簡単にできるようにできたらと思い作成する。

## 仕様

### 実装する仕様

- [Yahoo!路線情報](https://transit.yahoo.co.jp/diainfo)を用いて路線情報を取得する（スクレイピング）
- サイトに負担をかけないよう取得するのは朝の1回と任意のタイミングのみとする
- linebotを用いてラインから通知が来るようにする
- 任意の路線情報を登録できるようにする
- 遅延があった際にlinebotから通知を送るようにする
- 利用者の希望するタイミングで情報を取得できるようにする

## 使用技術

- Ruby on Rails
- Line Messaging API

### 選択理由

普段使いできるものとしてブラウザを用意するのではなく、Lineで応答できるようにする。
この規模のアプリであれば本来Sinatraで十分だが、保守しやすいよう普段から使っているRailsを使用することにする。

## 各クラスの概要

### Model

#### User

- 利用者のline_idの保存
- 利用をやめた際は削除する

#### Train

- userとアソシエーションを組む
- 利用者の希望の路線を登録する

### Controller

#### LinebotController

- コールバック機能
> 送られてきたline_id、メッセージを取得する

> controllerから送られてきたline_idをもとにRalisに登録されているUserの割り出し

> ともだち登録された際にRails側に保存、解除と同時にRailsから情報を削除する

> テキストの内容に応じてサービスクラスを呼び出す。対応していない文字の場合は特定の文章を返す

### Service

#### YahooTrainService

- スクレイピング機能
- 送られてきたurlを元に路線情報をスクレイピングし、路線情報を返す

#### TextResponseService

- Controllerからテキスト内容、user情報を受け取る
- 対応した文字列に応じてそれぞれの処理を行う
> 路線情報のリンクが送られてきた場合、リンク情報を登録

> 情報等の文字列が送られてきた場合、スクレイピングした情報を返す

> 削除等の文字列が送られてきた場合、userのtrain情報を削除する

### Batch

- 登録されている全userのtrain情報を洗い出す
- 遅延があった場合遅延情報をlineに送る

## 実装

### 処理フロー

[フローチャートとER図](https://drive.google.com/file/d/1ZI8HXaLraTNMJ65L1-0JzZ0s6-wOwlye/view?usp=sharing)

## セキュリティやプライバシーについての考察

line_idを暗号化するかどうか？
> [LINE Developers](https://developers.line.biz/ja/faq/#what-are-userid-groupid-and-roomid)によるとline_idはチャンネルのプロバイダーごとに別発行される。つまりline_idが漏れたとしてもこのbotにしか影響を与えないため今回は別段考慮しない。

## 実装計画

### 基礎作成

- rails newからデプロイまで 1h
- railsとline連携 1h
- 文字列を送った際に'Hello World'と返信させる

### 処理土台作成

- データベース作成 10m
- 友達登録の際にDBにline_idを保存、解除の際に削除 30m
- Yahoo路線情報のurlを作ったスクレイピング機能 2h

### 使えるように実装

- フローチャートに乗っ取った処理の作成 3h
- batch作成 1h

1day 基礎作成  
2day 処理土台作成  
3day 使えるように実装  
4day 調整日  
5day reademe作成  
6day デバッグとサービス公開  
